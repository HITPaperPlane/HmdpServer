<mxfile host="Electron" agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) draw.io/29.0.3 Chrome/140.0.7339.249 Electron/38.7.0 Safari/537.36" version="29.0.3">
  <diagram name="Follow_Code_Core" id="follow-code-core">
    <mxGraphModel dx="2700" dy="1600" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="827" pageHeight="1169" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />
        <mxCell id="2" value="关注（按代码实现）：关注/取关（DB+Redis Set）+ 共同关注(SINTER) + 我的关注列表 + 预加载收件箱（严格对照当前代码）" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#1f2937;strokeColor=#111827;fontColor=#ffffff;fontStyle=1;fontSize=16;align=center;verticalAlign=middle;" vertex="1" parent="1">
          <mxGeometry x="40" y="10" width="2500" height="50" as="geometry" />
        </mxCell>

        <!-- Swimlanes -->
        <mxCell id="10" value="Client（用户）" style="swimlane;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#d6b656;startSize=30;fontStyle=1;fontSize=14;" vertex="1" parent="1">
          <mxGeometry x="40" y="80" width="260" height="1220" as="geometry" />
        </mxCell>
        <mxCell id="20" value="hmdp-service :8088&#xa;(FollowController/FollowServiceImpl)" style="swimlane;whiteSpace=wrap;html=1;fillColor=#d5e8d4;strokeColor=#82b366;startSize=30;fontStyle=1;fontSize=14;" vertex="1" parent="1">
          <mxGeometry x="320" y="80" width="620" height="1220" as="geometry" />
        </mxCell>
        <mxCell id="30" value="Redis Cluster&#xa;(follows SET + feed inbox)" style="swimlane;whiteSpace=wrap;html=1;fillColor=#fff0f5;strokeColor=#b85450;startSize=30;fontStyle=1;fontSize=14;" vertex="1" parent="1">
          <mxGeometry x="960" y="80" width="520" height="1220" as="geometry" />
        </mxCell>
        <mxCell id="40" value="MySQL 123.56.100.212:3306/hmdp&#xa;(tb_follow/tb_user_info/tb_blog)" style="swimlane;whiteSpace=wrap;html=1;fillColor=#f8cecc;strokeColor=#b85450;startSize=30;fontStyle=1;fontSize=14;" vertex="1" parent="1">
          <mxGeometry x="1500" y="80" width="1040" height="1220" as="geometry" />
        </mxCell>

        <!-- Client -->
        <mxCell id="11" value="A1 是否关注&#xa;GET /follow/or/not/{authorId}" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#d6b656;fontSize=12;align=left;" vertex="1" parent="10">
          <mxGeometry x="20" y="60" width="220" height="70" as="geometry" />
        </mxCell>
        <mxCell id="12" value="A2 关注/取关&#xa;PUT /follow/{authorId}/{true|false}" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#d6b656;fontSize=12;align=left;" vertex="1" parent="10">
          <mxGeometry x="20" y="150" width="220" height="70" as="geometry" />
        </mxCell>
        <mxCell id="13" value="B1 共同关注&#xa;GET /follow/common/{id}" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#d6b656;fontSize=12;align=left;" vertex="1" parent="10">
          <mxGeometry x="20" y="470" width="220" height="70" as="geometry" />
        </mxCell>
        <mxCell id="14" value="B2 我的关注列表&#xa;GET /follow/of/me" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#d6b656;fontSize=12;align=left;" vertex="1" parent="10">
          <mxGeometry x="20" y="560" width="220" height="70" as="geometry" />
        </mxCell>

        <!-- hmdp-service -->
        <mxCell id="21" value="FollowController&#xa;GET /follow/or/not/{id}&#xa;PUT /follow/{id}/{isFollow}&#xa;GET /follow/common/{id}&#xa;GET /follow/of/me" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#82b366;fontSize=11;align=left;" vertex="1" parent="20">
          <mxGeometry x="20" y="60" width="580" height="110" as="geometry" />
        </mxCell>
        <mxCell id="22" value="FollowServiceImpl.isFollow(followUserId)&#xa;DB: SELECT COUNT(*) FROM tb_follow WHERE user_id=? AND follow_user_id=?&#xa;return count&gt;0&#xa;（isFollow 不读 Redis）" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#82b366;fontSize=10;align=left;" vertex="1" parent="20">
          <mxGeometry x="20" y="180" width="580" height="100" as="geometry" />
        </mxCell>
        <mxCell id="23" value="FollowServiceImpl.follow(true) @Transactional&#xa;1) 若 DB 已存在 → SADD follows:&lt;uid&gt; 幂等返回&#xa;2) INSERT tb_follow(user_id,follow_user_id)&#xa;3) ensureUserInfoExists(uid/followId)；更新 tb_user_info：followee+1 / fans+1&#xa;4) SADD follows:&lt;uid&gt; followId&#xa;5) preloadRecentBlogs：查作者最近10篇 tb_blog → ZADD feed:&lt;uid&gt;（EXPIRE 1day）" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#82b366;fontSize=10;align=left;" vertex="1" parent="20">
          <mxGeometry x="20" y="290" width="580" height="190" as="geometry" />
        </mxCell>
        <mxCell id="24" value="FollowServiceImpl.follow(false) @Transactional&#xa;1) DELETE tb_follow WHERE user_id=? AND follow_user_id=? LIMIT 1&#xa;2) 若 deleted&gt;0：更新 tb_user_info：followee-1/fans-1（IF 保底不小于0）&#xa;3) SREM follows:&lt;uid&gt; followId&#xa;（不删除 feed inbox）" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#82b366;fontSize=10;align=left;" vertex="1" parent="20">
          <mxGeometry x="20" y="490" width="580" height="130" as="geometry" />
        </mxCell>
        <mxCell id="25" value="FollowServiceImpl.followCommons(id)&#xa;key1=follows:&lt;id&gt; ; key2=follows:&lt;uid&gt;&#xa;SINTER key1 key2 → ids&#xa;再查 tb_user/tb_user_info.icon → UserDTO 列表" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#82b366;fontSize=10;align=left;" vertex="1" parent="20">
          <mxGeometry x="20" y="640" width="580" height="110" as="geometry" />
        </mxCell>
        <mxCell id="26" value="FollowServiceImpl.queryMyFollows()&#xa;1) SELECT tb_follow WHERE user_id=? ORDER BY create_time DESC&#xa;2) 去重 follow_user_id（保序）&#xa;3) 批量查 tb_user + tb_user_info&#xa;4) 返回 FollowUserDTO{userId,nickName,role,icon,introduce}" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#82b366;fontSize=10;align=left;" vertex="1" parent="20">
          <mxGeometry x="20" y="770" width="580" height="140" as="geometry" />
        </mxCell>
        <mxCell id="27" value="WHY：共同关注用 Redis SINTER&#xa;O(n) 交集 + 不打 DB；但 isFollow 仍走 DB 确保强一致（避免 Redis 漏写导致误判）" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#fff2cc;strokeColor=#82b366;fontSize=11;align=left;" vertex="1" parent="20">
          <mxGeometry x="20" y="930" width="580" height="90" as="geometry" />
        </mxCell>

        <!-- Redis -->
        <mxCell id="31" value="SET&#xa;follows:&lt;uid&gt;&#xa;member=followUserId&#xa;（关注关系缓存；无 TTL）" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#b85450;fontSize=11;align=left;" vertex="1" parent="30">
          <mxGeometry x="20" y="320" width="240" height="90" as="geometry" />
        </mxCell>
        <mxCell id="32" value="SINTER follows:&lt;id&gt; follows:&lt;uid&gt;&#xa;→ common follow ids" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#b85450;fontSize=11;align=left;" vertex="1" parent="30">
          <mxGeometry x="20" y="650" width="240" height="80" as="geometry" />
        </mxCell>
        <mxCell id="33" value="ZSET&#xa;feed:&lt;uid&gt;&#xa;member=blogId score=createTimeMs&#xa;EXPIRE=1day&#xa;写入点：preloadRecentBlogs / feed-service 扇出" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#b85450;fontSize=10;align=left;" vertex="1" parent="30">
          <mxGeometry x="280" y="360" width="220" height="120" as="geometry" />
        </mxCell>

        <!-- MySQL -->
        <mxCell id="41" value="tb_follow&#xa;id(pk), user_id, follow_user_id, create_time&#xa;索引：idx_user_follow(user_id,follow_user_id)；idx_follow_user(follow_user_id,user_id)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#b85450;fontSize=10;align=left;" vertex="1" parent="40">
          <mxGeometry x="20" y="210" width="520" height="110" as="geometry" />
        </mxCell>
        <mxCell id="42" value="tb_user_info&#xa;fans, followee 计数字段&#xa;关注：+1；取关：-1(IF&gt;0)" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#ffffff;strokeColor=#b85450;fontSize=10;align=left;" vertex="1" parent="40">
          <mxGeometry x="20" y="340" width="520" height="90" as="geometry" />
        </mxCell>
        <mxCell id="43" value="preloadRecentBlogs&#xa;SELECT tb_blog WHERE user_id=followUserId ORDER BY create_time DESC LIMIT 10&#xa;（为空则不写 feed）" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#b85450;fontSize=10;align=left;" vertex="1" parent="40">
          <mxGeometry x="20" y="450" width="520" height="90" as="geometry" />
        </mxCell>
        <mxCell id="44" value="queryMyFollows&#xa;SELECT tb_follow WHERE user_id=? ORDER BY create_time DESC&#xa;再批量查 tb_user/tb_user_info" style="rounded=1;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#b85450;fontSize=10;align=left;" vertex="1" parent="40">
          <mxGeometry x="20" y="780" width="520" height="90" as="geometry" />
        </mxCell>

        <!-- Edges -->
        <mxCell id="e1" value="HTTP" style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;fontSize=10;" edge="1" parent="1" source="11" target="21">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e2" value="COUNT(*)" style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;fontSize=10;dashed=1;" edge="1" parent="1" source="22" target="41">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e3" value="HTTP" style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;fontSize=10;" edge="1" parent="1" source="12" target="21">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e4" value="INSERT/DELETE" style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;fontSize=10;dashed=1;" edge="1" parent="1" source="23" target="41">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e5" value="SADD/SREM" style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;fontSize=10;strokeWidth=2;" edge="1" parent="1" source="23" target="31">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e6" value="UPDATE fans/followee" style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;fontSize=10;dashed=1;" edge="1" parent="1" source="23" target="42">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e7" value="查最近10篇" style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;fontSize=10;dashed=1;" edge="1" parent="1" source="23" target="43">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e8" value="ZADD feed inbox" style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;fontSize=10;strokeWidth=2;" edge="1" parent="1" source="23" target="33">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e9" value="DELETE limit 1" style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;fontSize=10;dashed=1;" edge="1" parent="1" source="24" target="41">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e10" value="SINTER" style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;fontSize=10;strokeWidth=2;" edge="1" parent="1" source="25" target="32">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e11" value="HTTP" style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;fontSize=10;" edge="1" parent="1" source="13" target="21">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e12" value="HTTP" style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;fontSize=10;" edge="1" parent="1" source="14" target="21">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
        <mxCell id="e13" value="SELECT follows + users" style="edgeStyle=orthogonalEdgeStyle;rounded=0;html=1;fontSize=10;dashed=1;" edge="1" parent="1" source="26" target="44">
          <mxGeometry relative="1" as="geometry" />
        </mxCell>
      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
